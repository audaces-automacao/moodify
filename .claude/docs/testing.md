# Testing Guidelines

Moodify frontend uses Vitest for unit testing with 80% minimum coverage. Tests run in jsdom via Angular's built-in `@angular/build:unit-test` builder.

## Commands

```cmd
test.cmd               # Run ALL tests (backend + frontend)
test-coverage.cmd      # Run ALL tests with coverage reports
```

```bash
npm test           # Frontend only: watch mode
npm run test:ci    # Frontend only: single run with coverage (CI)
cd server && npm test  # Backend only
```

> **Windows Note**: Run test commands from PowerShell or cmd.exe. Git Bash (MSYS2) has a known incompatibility with Vitest's worker initialization that causes "Vitest failed to find the runner" errors.

## Test Structure

Each component/service has a `.spec.ts` file alongside it:
- `src/app/app.spec.ts`
- `src/app/components/*.spec.ts`
- `src/app/services/*.spec.ts`
- `src/app/auth/*.spec.ts`

## Writing Tests

### Test File Location
Place `.spec.ts` files next to the file being tested.

### Test Organization
Use `describe` blocks for the component/service name. Use `it` blocks with clear behavior descriptions.

### Component Test Setup
Standalone components are imported directly in `TestBed` (see `mood-input.component.spec.ts`):
```
TestBed.configureTestingModule({
  imports: [MyComponent, TranslocoTestingModule.forRoot(...)],
})
```

### Service Test Setup
Use `provideHttpClient()` + `provideHttpClientTesting()` for HTTP services (see `openai.service.spec.ts`):
```
TestBed.configureTestingModule({
  providers: [MyService, provideHttpClient(), provideHttpClientTesting()],
})
```

### i18n in Tests
Use `TranslocoTestingModule.forRoot()` with inline translations for component tests that use `TranslocoPipe`.

### Mocking
- HTTP calls: Angular's `HttpTestingController` with `httpMock.verify()` in `afterEach`
- Services: Create mock objects with `vi.fn()` methods:
  ```typescript
  const serviceMock = {
    method1: vi.fn(),
    method2: vi.fn(),
  };
  serviceMock.method1.mockReturnValue(of(true));
  ```
- Spying on existing methods: `vi.spyOn(object, 'method')`
- For OpenAI service tests, mock the full API response shape (see `openai.service.spec.ts`)

### jsdom Limitations
Tests run in jsdom instead of a real browser. Some APIs need polyfills or workarounds:
- `scrollIntoView`: Assign `Element.prototype.scrollIntoView = vi.fn()` in `beforeEach`
- `matchMedia`: Use `vi.stubGlobal('matchMedia', vi.fn().mockReturnValue(...))` since jsdom doesn't implement it
- `img.loading` property: Use `getAttribute('loading')` instead of the DOM property

### Signal Testing
Access signal values via `component.signalName()` call syntax.

### Coverage
- Coverage reports in `coverage/` directory
- Generated by `@vitest/coverage-v8`
- Minimum threshold: 80% statements, branches, functions, lines
